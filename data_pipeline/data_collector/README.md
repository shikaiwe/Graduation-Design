# 沪深300成分股数据采集程序

## 概述

本程序使用AKshare接口获取沪深300成分股在2019-2024年期间的日频数据，支持分批处理和频率控制，有效规避因请求频率过高导致的访问限制。

## 功能特性

- ✅ **时间范围可配置**：支持自定义开始和结束日期
- ✅ **分批处理机制**：每批次处理指定数量的股票，避免单次请求过多
- ✅ **频率控制**：智能延迟机制，避免触发API限制
- ✅ **错误重试**：自动重试失败的请求
- ✅ **恢复模式**：支持从断点继续处理
- ✅ **详细日志**：完整的运行日志和统计信息

## 目录结构

```
data_collector/
├── __init__.py          # 包初始化文件
├── config.py            # 配置文件
├── data_collector.py    # 主数据采集程序
├── cli.py              # 命令行工具
├── utils.py            # 工具函数
└── README.md           # 说明文档
```

## 安装依赖

```bash
pip install -r ../requirements.txt
```

## 使用方法

### 1. 使用默认配置运行

```bash
python cli.py
```

### 2. 使用自定义参数运行

```bash
# 指定时间范围和批次大小
python cli.py --start-date 2020-01-01 --end-date 2023-12-31 --batch-size 10

# 使用恢复模式（跳过已处理的股票）
python cli.py --resume

# 试运行模式（不实际获取数据）
python cli.py --dry-run

# 详细输出模式
python cli.py --verbose
```

### 3. 参数说明

| 参数 | 缩写 | 默认值 | 说明 |
|------|------|--------|------|
| `--start-date` | `-s` | `2019-01-01` | 数据开始日期 |
| `--end-date` | `-e` | `2024-12-31` | 数据结束日期 |
| `--batch-size` | `-b` | `20` | 每批次处理的股票数量 |
| `--delay` | `-d` | `2.0` | 请求间隔时间（秒） |
| `--max-retries` | `-r` | `3` | 最大重试次数 |
| `--resume` | 无 | `False` | 恢复模式，跳过已处理的股票 |
| `--dry-run` | 无 | `False` | 试运行模式，不实际获取数据 |
| `--verbose` | `-v` | `False` | 详细输出模式 |

## 输出文件

数据将保存到 `../data/daily_prices/` 目录，文件命名格式为：

```
hs300_daily_prices_batch_001_20251014_143022.csv
hs300_daily_prices_batch_002_20251014_143125.csv
...
```

### 数据字段说明

每个CSV文件包含以下字段：

| 字段名 | 说明 | 数据类型 |
|--------|------|----------|
| `date` | 交易日期 | string |
| `open` | 开盘价 | float |
| `close` | 收盘价 | float |
| `high` | 最高价 | float |
| `low` | 最低价 | float |
| `volume` | 成交量 | float |
| `amount` | 成交额 | float |
| `amplitude` | 振幅 | float |
| `change_rate` | 涨跌幅 | float |
| `change_amount` | 涨跌额 | float |
| `turnover_rate` | 换手率 | float |
| `stock_code` | 股票代码 | string |
| `stock_name` | 股票名称 | string |
| `symbol` | AKshare股票符号 | string |

## 配置说明

### 主要配置参数（config.py）

```python
# 基础路径配置
BASE_DATA_DIR = "../data"
COMPONENTS_FILE = "../data/components/hs300_components_20251014.csv"
OUTPUT_DIR = "../data/daily_prices"

# 时间范围配置
START_DATE = "2019-01-01"
END_DATE = "2024-12-31"

# 数据采集配置
BATCH_SIZE = 20          # 每批次处理的股票数量
REQUEST_DELAY = 2         # 请求间隔时间（秒）
MAX_RETRIES = 3          # 最大重试次数
RETRY_DELAY = 5          # 重试间隔时间（秒）
```

### 股票代码映射

程序自动根据股票代码前缀映射到对应的交易所：

- 上海证券交易所：`600`, `601`, `603`, `605`, `688` → `sh`
- 深圳证券交易所：`000`, `001`, `002`, `003`, `300`, `301` → `sz`

## 错误处理

### 常见错误及解决方案

1. **网络连接错误**
   - 程序会自动重试（最多3次）
   - 检查网络连接
   - 适当增加请求间隔时间

2. **API限制错误**
   - 自动延迟处理
   - 建议设置 `--delay 3` 或更高

3. **股票数据缺失**
   - 某些股票在指定时间段可能无数据
   - 程序会记录并跳过这些股票

### 日志文件

程序运行日志保存在 `../data/logs/data_collector.log`

## 性能优化建议

1. **批次大小**：根据网络状况调整批次大小（10-30之间）
2. **请求间隔**：建议设置为2-5秒以避免API限制
3. **恢复模式**：中断后使用 `--resume` 参数继续处理
4. **网络环境**：确保稳定的网络连接

## 注意事项

1. **数据完整性**：程序会自动跳过已处理的股票，确保数据不重复
2. **时间范围**：确保开始日期不晚于结束日期
3. **文件权限**：确保程序有写入输出目录的权限
4. **依赖版本**：使用requirements.txt中指定的版本以确保兼容性

## 技术支持

如遇到问题，请检查：
1. 依赖包是否安装正确
2. 网络连接是否正常
3. 配置文件路径是否正确
4. 查看日志文件获取详细错误信息